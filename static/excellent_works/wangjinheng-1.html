<!DOCTYPE html>
<html>
<head>
  <title>人口分布统计图</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body {
        margin: 100px;
        font-family: Serif;
    }
    #vis1 {
      position: absolute; 
      top: 50px;          
      left: 180px;        
    }
    .label {
      position: absolute; 
      left:190px;
      top: 30px; 
      font-size: 20px
    }
    .label.year {
      left: 600px;
      top:500px;
      font-size: 30px
    }
    .label.sex{
      left:250px;
      top:520px
    }
  </style>
</head>
<body>
  <div id="vis1"></div>
  <div class="label">注释1：从上往下数第四行和第八行代表的意思是男性和女性各自不同的年龄段的人数分别占当年男女总人数的比例，男性在右边，女性在左边</div>
  <div class="label year">美国1900和2000年龄段比例关系以及男女比例关系</div>
  <script>
       const data1=[
          {"Sex": "1", "Year": "1900", "Age": "0", "People": 4619544},
          {"Sex": "1", "Year": "2000", "Age": "0", "People": 9735380},
          {"Sex": "1", "Year": "1900", "Age": "5", "People": 4465783},
          {"Sex": "1", "Year": "2000", "Age": "5", "People": 10552146},
          {"Sex": "1", "Year": "1900", "Age": "10", "People": 4057669},
          {"Sex": "1", "Year": "2000", "Age": "10", "People": 10563233},
          {"Sex": "1", "Year": "1900", "Age": "15", "People": 3774846},
          {"Sex": "1", "Year": "2000", "Age": "15", "People": 10237419},
          {"Sex": "1", "Year": "1900", "Age": "20", "People": 3694038},
          {"Sex": "1", "Year": "2000", "Age": "20", "People": 9731315},
          {"Sex": "1", "Year": "1900", "Age": "25", "People": 3389280},
          {"Sex": "1", "Year": "2000", "Age": "25", "People": 9659493},
          {"Sex": "1", "Year": "1900", "Age": "30", "People": 2918964},
          {"Sex": "1", "Year": "2000", "Age": "30", "People": 10205879},
          {"Sex": "1", "Year": "1900", "Age": "35", "People": 2633883},
          {"Sex": "1", "Year": "2000", "Age": "35", "People": 11475182},
          {"Sex": "1", "Year": "1900", "Age": "40", "People": 2261070},
          {"Sex": "1", "Year": "2000", "Age": "40", "People": 11320252},
          {"Sex": "1", "Year": "1900", "Age": "45", "People": 1868413},
          {"Sex": "1", "Year": "2000", "Age": "45", "People": 9925006},
          {"Sex": "1", "Year": "1900", "Age": "50", "People": 1571038},
          {"Sex": "1", "Year": "2000", "Age": "50", "People": 8507934},
          {"Sex": "1", "Year": "1900", "Age": "55", "People": 1161908},
          {"Sex": "1", "Year": "2000", "Age": "55", "People": 6459082},
          {"Sex": "1", "Year": "1900", "Age": "60", "People": 916571},
          {"Sex": "1", "Year": "2000", "Age": "60", "People": 5123399},
          {"Sex": "1", "Year": "1900", "Age": "65", "People": 672663},
          {"Sex": "1", "Year": "2000", "Age": "65", "People": 4453623},
          {"Sex": "1", "Year": "1900", "Age": "70", "People": 454747},
          {"Sex": "1", "Year": "2000", "Age": "70", "People": 3792145},
          {"Sex": "1", "Year": "1900", "Age": "75", "People": 268211},
          {"Sex": "1", "Year": "2000", "Age": "75", "People": 2912655},
          {"Sex": "1", "Year": "1900", "Age": "80", "People": 127435},
          {"Sex": "1", "Year": "2000", "Age": "80", "People": 1902638},
          {"Sex": "1", "Year": "1900", "Age": "85", "People": 44008},
          {"Sex": "1", "Year": "2000", "Age": "85", "People": 970357},
          {"Sex": "1", "Year": "1900", "Age": "90", "People": 15164},
          {"Sex": "1", "Year": "2000", "Age": "90", "People": 336303},
          {"Sex": "2", "Year": "1900", "Age": "0", "People": 4589196},
          {"Sex": "2", "Year": "2000", "Age": "0", "People": 9310714},
          {"Sex": "2", "Year": "1900", "Age": "5", "People": 4390483},
          {"Sex": "2", "Year": "2000", "Age": "5", "People": 10069564},
          {"Sex": "2", "Year": "1900", "Age": "10", "People": 4001749},
          {"Sex": "2", "Year": "2000", "Age": "10", "People": 10022524},
          {"Sex": "2", "Year": "1900", "Age": "15", "People": 3801743},
          {"Sex": "2", "Year": "2000", "Age": "15", "People": 9692669},
          {"Sex": "2", "Year": "1900", "Age": "20", "People": 3751061},
          {"Sex": "2", "Year": "2000", "Age": "20", "People": 9324244},
          {"Sex": "2", "Year": "1900", "Age": "25", "People": 3236056},
          {"Sex": "2", "Year": "2000", "Age": "25", "People": 9518507},
          {"Sex": "2", "Year": "1900", "Age": "30", "People": 2665174},
          {"Sex": "2", "Year": "2000", "Age": "30", "People": 10119296},
          {"Sex": "2", "Year": "1900", "Age": "35", "People": 2347737},
          {"Sex": "2", "Year": "2000", "Age": "35", "People": 11635647},
          {"Sex": "2", "Year": "1900", "Age": "40", "People": 2004987},
          {"Sex": "2", "Year": "2000", "Age": "40", "People": 11488578},
          {"Sex": "2", "Year": "1900", "Age": "45", "People": 1648025},
          {"Sex": "2", "Year": "2000", "Age": "45", "People": 10261253},
          {"Sex": "2", "Year": "1900", "Age": "50", "People": 1411981},
          {"Sex": "2", "Year": "2000", "Age": "50", "People": 8911133},
          {"Sex": "2", "Year": "1900", "Age": "55", "People": 1064632},
          {"Sex": "2", "Year": "2000", "Age": "55", "People": 6921268},
          {"Sex": "2", "Year": "1900", "Age": "60", "People": 887508},
          {"Sex": "2", "Year": "2000", "Age": "60", "People": 5668961},
          {"Sex": "2", "Year": "1900", "Age": "65", "People": 640212},
          {"Sex": "2", "Year": "2000", "Age": "65", "People": 4804784},
          {"Sex": "2", "Year": "1900", "Age": "70", "People": 440007},
          {"Sex": "2", "Year": "2000", "Age": "70", "People": 5184855},
          {"Sex": "2", "Year": "1900", "Age": "75", "People": 265879},
          {"Sex": "2", "Year": "2000", "Age": "75", "People": 4355644},
          {"Sex": "2", "Year": "1900", "Age": "80", "People": 132449},
          {"Sex": "2", "Year": "2000", "Age": "80", "People": 3221898},
          {"Sex": "2", "Year": "1900", "Age": "85", "People": 48614},
          {"Sex": "2", "Year": "2000", "Age": "85", "People": 1981156},
          {"Sex": "2", "Year": "1900", "Age": "90", "People": 20093},
          {"Sex": "2", "Year": "2000", "Age": "90", "People": 1064581}
      ]
      const data2 = data1.map(source => {
      if(source.Age=='60'||source.Age=='65'||source.Age=='70'||source.Age=='75'||source.Age=='80'||source.Age=='85'||source.Age=='90')
      return {"Sex":source.Sex,"Year":source.Year,"Age":'>=60',"People":source.People}
       else if (source.Age=='50'||source.Age=='55') {
        return {"Sex":source.Sex,"Year":source.Year,"Age":'50-59',"People":source.People};
      }
      else if(source.Age=='0'||source.Age=='5'){
        return {"Sex":source.Sex,"Year":source.Year,"Age":'0-9',"People":source.People};
      }
      else if(source.Age=='10'||source.Age=='15'){
        return {"Sex":source.Sex,"Year":source.Year,"Age":'10-19',"People":source.People};
      }
      else if(source.Age=='20'||source.Age=='25'){
        return {"Sex":source.Sex,"Year":source.Year,"Age":'20-29',"People":source.People};
      }
      else if(source.Age=='30'||source.Age=='35'){
        return {"Sex":source.Sex,"Year":source.Year,"Age":'30-39',"People":source.People};
      }
      else if(source.Age=='40'||source.Age=='45'){
        return {"Sex":source.Sex,"Year":source.Year,"Age":'40-49',"People":source.People};
      }
      else return source
      });
      const data3 = data2.reduce((result, source) => {
        if (result.find(x1=>x1.Sex==source.Sex&&x1.Year==source.Year&&x1.Age==source.Age)) {
          result.find(x1=>x1.Sex==source.Sex&&x1.Year==source.Year&&x1.Age==source.Age).People+=source.People
        } 
        else {
          result.push(source);
        }
        return result;
      }, []);
      const data4 = data3.map(zyw => ({
        ...zyw,
        Year: zyw.Sex === "1"?(zyw.Year==="1900" ? "1900男性各年龄段占男性总数比" : "2000男性各年龄段占男性总数比"):(zyw.Year==="1900" ? "1900女性各年龄段占女性总数比" : "2000女性各年龄段占女性总数比")
      }));
      data3.map(source=>{
        if(source.Year==='1900'||source.Year==='2000')
        source.Year+='（本行含义见注释1）'
      })
      console.log(data4)
      const adata=[
      {"Sex":"1","Year": "1900-男女性别比例", "Age":"总人数","People": 38915235},
      {"Sex":"2","Year": "1900-男女性别比例", "Age":"总人数","People": 37347586},
      {"Sex":"1","Year": "2000-男女性别比例", "Age":"总人数","People": 137863441},
      {"Sex":"2","Year": "2000-男女性别比例","Age":"总人数","People": 143557276}
      ]
      data3.push(...adata);
      const data5 = [...data3, ...data4];
    const spec = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "data": {
        "values": data5
      },

      "description": "美国1900和2000年龄段比例关系以及男女比例关系",
      "transform": [
      {
      "joinaggregate": [
        {"op": "sum", "field": "People", "as": "TotalPeople"}
      ],
      "groupby": ["Year"] 
    },

        {
          "calculate": "datum.People / datum.TotalPeople",
          "as": "datapercent"
        },
        {
          "calculate": "datum.Sex === '1' ? '男' :'女'",
          "as": "性别"
        },
        {
          "calculate": "datum.性别 + ':' + datum.Age ",
          "as": "new_age"
        }

      ],
      "width": 1300,
      "height": 400,
      
        "mark": {
          "type": "bar",
          "tooltip": {
          "signal": "datum ? { '性别/年龄段': datum.new_age, '人数': datum.People, '百分比': datum.datapercent } : null"
  }

      } ,
      "encoding": {
        "x": {
          "field": "datapercent",
          "type": "quantitative",
          "title": "百分比",
          "axis": {"format": "%"},
          "stack": "normalize"
        },
        "y": {
          "field": "Year",
          "type": "nominal",
          "title": "",
        },
        "color": {
          "field": "new_age",
          "type": "nominal",
          "title":"比例尺",
          "scale": {
            "domain": [ "女:总人数", "男:总人数","女:0-9", "女:10-19", "女:20-29", "女:30-39", "女:40-49", "女:50-59", "女:>=60", "男:0-9", "男:10-19", "男:20-29", "男:30-39", "男:40-49", "男:50-59", "男:>=60"],
             "range":   ["#FF0000", "#000000","#FFFFE0", "#FFB6C1", "#FF69B4", "#FF1493", "#FF7F50", "#FF6347", "#FFA07A", "#000080", "#0000CD", "#4169E1", "#2E8B57", "#006400", "#228B22", "#4B3D3A"]
          }


        }
      },
      "config": {
        "axis": {"labelFontSize": 12, "titleFontSize": 14}
      }
    };
    vegaEmbed("#vis1", spec);
  
  </script>
</body>
</html>